#!/bin/bash

# ============================================================
# 마스터 벤치마크 스크립트
# ============================================================
#
# 모든 성능 검증 테스트를 순차적으로 실행합니다.
# 각 테스트는 독립적으로 실행되며, 결과는 콘솔에 출력됩니다.
#
# 테스트 목록:
# 1. 배치 INSERT 효과
# 2. synchronous_commit 효과
# 3. 인덱스 효과
# 4. 커버링 인덱스 효과
# 5. work_mem 효과
# 6. 격리 수준 효과
#
# 총 소요 시간: 약 18분 (각 테스트 30초 × 2 × 6개)
#
# ============================================================

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LOG_DIR="${SCRIPT_DIR}/../benchmark-results"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

# 결과 디렉토리 생성
mkdir -p ${LOG_DIR}

echo "============================================================"
echo "PostgreSQL 성능 최적화 벤치마크 테스트 Suite"
echo "============================================================"
echo ""
echo "시작 시간: $(date)"
echo "결과 저장: ${LOG_DIR}/benchmark_${TIMESTAMP}.log"
echo ""
echo "📋 테스트 계획:"
echo "   1. 배치 INSERT 효과 (batch_size 1 vs 100)"
echo "   2. synchronous_commit 효과 (on vs off)"
echo "   3. 인덱스 효과 (없음 vs 있음)"
echo "   4. 커버링 인덱스 효과 (일반 vs 커버링)"
echo "   5. work_mem 효과 (4MB vs 256MB)"
echo "   6. 격리 수준 효과 (READ COMMITTED vs REPEATABLE READ)"
echo ""
echo "예상 소요 시간: 약 18분"
echo ""
read -p "계속하시겠습니까? (y/n): " -n 1 -r
echo ""

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "테스트를 취소했습니다."
    exit 0
fi

echo ""
echo "============================================================"
echo "테스트 시작..."
echo "============================================================"
echo ""

# 로그 파일 시작
LOGFILE="${LOG_DIR}/benchmark_${TIMESTAMP}.log"
echo "PostgreSQL 성능 최적화 벤치마크 결과" > ${LOGFILE}
echo "실행 시간: $(date)" >> ${LOGFILE}
echo "============================================================" >> ${LOGFILE}
echo "" >> ${LOGFILE}

# ============================================================
# 테스트 1: 배치 INSERT 효과
# ============================================================

echo ""
echo "▶️  [1/6] 배치 INSERT 효과 테스트 시작..."
echo ""

${SCRIPT_DIR}/benchmark-01-batch-insert.sh 2>&1 | tee -a ${LOGFILE}

echo ""
echo "✅ 테스트 1 완료"
echo ""
echo "잠시 대기 중... (시스템 안정화)"
sleep 10

# ============================================================
# 테스트 2: synchronous_commit 효과
# ============================================================

echo ""
echo "▶️  [2/6] synchronous_commit 효과 테스트 시작..."
echo ""

${SCRIPT_DIR}/benchmark-02-synchronous-commit.sh 2>&1 | tee -a ${LOGFILE}

echo ""
echo "✅ 테스트 2 완료"
echo ""
echo "잠시 대기 중..."
sleep 10

# ============================================================
# 테스트 3: 인덱스 효과
# ============================================================

echo ""
echo "▶️  [3/6] 인덱스 효과 테스트 시작..."
echo ""

${SCRIPT_DIR}/benchmark-03-index-effect.sh 2>&1 | tee -a ${LOGFILE}

echo ""
echo "✅ 테스트 3 완료"
echo ""
echo "잠시 대기 중..."
sleep 10

# ============================================================
# 테스트 4: 커버링 인덱스 효과
# ============================================================

echo ""
echo "▶️  [4/6] 커버링 인덱스 효과 테스트 시작..."
echo ""

${SCRIPT_DIR}/benchmark-04-covering-index.sh 2>&1 | tee -a ${LOGFILE}

echo ""
echo "✅ 테스트 4 완료"
echo ""
echo "잠시 대기 중..."
sleep 10

# ============================================================
# 테스트 5: work_mem 효과
# ============================================================

echo ""
echo "▶️  [5/6] work_mem 효과 테스트 시작..."
echo ""

${SCRIPT_DIR}/benchmark-05-work-mem.sh 2>&1 | tee -a ${LOGFILE}

echo ""
echo "✅ 테스트 5 완료"
echo ""
echo "잠시 대기 중..."
sleep 10

# ============================================================
# 테스트 6: 격리 수준 효과
# ============================================================

echo ""
echo "▶️  [6/6] 격리 수준 효과 테스트 시작..."
echo ""

${SCRIPT_DIR}/benchmark-06-isolation-level.sh 2>&1 | tee -a ${LOGFILE}

echo ""
echo "✅ 테스트 6 완료"
echo ""

# ============================================================
# 종료
# ============================================================

echo ""
echo "============================================================"
echo "🎉 모든 벤치마크 테스트 완료!"
echo "============================================================"
echo ""
echo "종료 시간: $(date)"
echo "결과 파일: ${LOGFILE}"
echo ""
echo "📊 요약:"
echo "   • 6개 테스트 모두 완료"
echo "   • 상세 결과는 위의 로그 파일 참조"
echo ""
echo "다음 단계:"
echo "   1. 로그 파일 검토"
echo "   2. 성능 지표 분석"
echo "   3. 프로덕션 적용 계획 수립"
echo ""
echo "============================================================"
