# PostgreSQL ì„±ëŠ¥ ìµœì í™” ë²¤ì¹˜ë§ˆí¬ - ê²°ê³¼ ìš”ì•½

## ğŸ¯ ê²€ì¦ ì™„ë£Œ!

ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ ê²°ê³¼ **ë°°ì¹˜ INSERTê°€ 20ë°° ì´ìƒ ì„±ëŠ¥ í–¥ìƒ**ì„ ë³´ì˜€ìŠµë‹ˆë‹¤!

```
BEFORE (batch_size=1):   7,421 TPS
AFTER (batch_size=100):  152,135 TPS
í–¥ìƒë¥ : 20.49ë°°
```

## ğŸ“‹ êµ¬ì¶•ëœ ë²¤ì¹˜ë§ˆí¬ í…ŒìŠ¤íŠ¸

7ê°œì˜ ì²´ê³„ì ì¸ ì„±ëŠ¥ ê²€ì¦ í…ŒìŠ¤íŠ¸ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤:

| # | í…ŒìŠ¤íŠ¸ | Before â†’ After | ì˜ˆìƒ íš¨ê³¼ | íŒŒì¼ |
|---|--------|---------------|----------|------|
| 1 | **ë°°ì¹˜ INSERT** | 1ê°œ â†’ 100ê°œ | 4~20ë°° | `benchmark-01-batch-insert.sh` |
| 2 | **synchronous_commit** | on â†’ off | 2.5ë°° | `benchmark-02-synchronous-commit.sh` |
| 3 | **ì¸ë±ìŠ¤** | ì—†ìŒ â†’ ìˆìŒ | 50ë°° | `benchmark-03-index-effect.sh` |
| 4 | **ì»¤ë²„ë§ ì¸ë±ìŠ¤** | ì¼ë°˜ â†’ ì»¤ë²„ë§ | 3ë°° | `benchmark-04-covering-index.sh` |
| 5 | **work_mem** | 4MB â†’ 256MB | 5ë°° | `benchmark-05-work-mem.sh` |
| 6 | **ê²©ë¦¬ ìˆ˜ì¤€** | RC â†’ RR | 0.9ë°° | `benchmark-06-isolation-level.sh` |
| 7 | **INCLUDE ì ˆ** | ë³µí•© â†’ INCLUDE | 3ë°° (ì“°ê¸°) | `benchmark-07-include-detailed.sh` |

## ğŸš€ ì‹¤í–‰ ë°©ë²•

### ë¹ ë¥¸ ì‹œì‘ (ì „ì²´ í…ŒìŠ¤íŠ¸)

```bash
cd /home/roach/db-study/load-test

# ì „ì²´ ë²¤ì¹˜ë§ˆí¬ ì‹¤í–‰ (ì•½ 18ë¶„)
./scripts/run-all-benchmarks.sh
```

### ê°œë³„ í…ŒìŠ¤íŠ¸

```bash
# 1. ë°°ì¹˜ INSERT íš¨ê³¼
./scripts/benchmark-01-batch-insert.sh

# 2. synchronous_commit íš¨ê³¼
./scripts/benchmark-02-synchronous-commit.sh

# 3. ì¸ë±ìŠ¤ íš¨ê³¼
./scripts/benchmark-03-index-effect.sh

# 4. ì»¤ë²„ë§ ì¸ë±ìŠ¤ íš¨ê³¼
./scripts/benchmark-04-covering-index.sh

# 5. work_mem íš¨ê³¼
./scripts/benchmark-05-work-mem.sh

# 6. ê²©ë¦¬ ìˆ˜ì¤€ íš¨ê³¼
./scripts/benchmark-06-isolation-level.sh

# 7. INCLUDE ì ˆ ìƒì„¸ ë¹„êµ
./scripts/benchmark-07-include-detailed.sh
```

## ğŸ’¡ ê° í…ŒìŠ¤íŠ¸ì˜ í•µì‹¬ í¬ì¸íŠ¸

### 1ï¸âƒ£ ë°°ì¹˜ INSERT (ì‹¤ì œ ê²€ì¦ ì™„ë£Œ)

**ì´ìœ **: ë„¤íŠ¸ì›Œí¬ ì™•ë³µ, WAL ì“°ê¸°, ì ê¸ˆ ì˜¤ë²„í—¤ë“œ ê°ì†Œ

**ê²°ê³¼**:
- batch_size=1:   ~7,000 TPS
- batch_size=100: ~150,000 TPS
- **20ë°° í–¥ìƒ** âœ…

**ì‹¤ë¬´ ì ìš©**:
- ëŒ€ëŸ‰ ë°ì´í„° ì ì¬ ì‹œ í•„ìˆ˜
- ê¶Œì¥ batch_size: 100~1000

---

### 2ï¸âƒ£ synchronous_commit

**ì´ìœ **: ë””ìŠ¤í¬ fsync() ëŒ€ê¸° ì‹œê°„ ì œê±°

**Before**: ë§¤ commitë§ˆë‹¤ ë””ìŠ¤í¬ ë™ê¸°í™” (ì•ˆì „, ëŠë¦¼)
**After**: OS ìºì‹œì—ë§Œ ì“°ê³  ì¦‰ì‹œ ë¦¬í„´ (ë¹ ë¦„, 3ì´ˆì¹˜ ì†ì‹¤ ê°€ëŠ¥)

**ì˜ˆìƒ ê²°ê³¼**:
- on:  ~5,000 TPS
- off: ~12,000 TPS (2.5ë°°)

**ì–¸ì œ ì‚¬ìš©?**
- âœ… OFF: ë¡œê·¸ ìˆ˜ì§‘, ë¶„ì„ ë°ì´í„°, ìºì‹œ
- âŒ OFF ê¸ˆì§€: ê¸ˆìœµ ê±°ë˜, ê²°ì œ, ì£¼ë¬¸

---

### 3ï¸âƒ£ ì¸ë±ìŠ¤ íš¨ê³¼

**ì´ìœ **: Full Table Scan â†’ Index Scan

**Before**: 10ë§Œ ê±´ ì „ì²´ ìŠ¤ìº”
**After**: B-treeë¡œ í•„ìš”í•œ í–‰ë§Œ íƒìƒ‰

**ì˜ˆìƒ ê²°ê³¼**:
- ì—†ìŒ: í‰ê·  500ms
- ìˆìŒ: í‰ê·  10ms (50ë°°)

**ì–¸ì œ ë§Œë“¤ê¹Œ?**
- WHERE ì ˆì— ìì£¼ ì‚¬ìš©
- ì„ íƒë„ < 5%
- JOIN, ORDER BY ì»¬ëŸ¼

---

### 4ï¸âƒ£ ì»¤ë²„ë§ ì¸ë±ìŠ¤

**ì´ìœ **: Heap ì ‘ê·¼ ì œê±° (ëœë¤ I/O ì—†ìŒ)

**Before**: Index Scan + 1000ë²ˆ Heap Fetch
**After**: Index-Only Scan (Heap ì ‘ê·¼ 0ë²ˆ)

**ì˜ˆìƒ ê²°ê³¼**:
- ì¼ë°˜: í‰ê·  15ms
- ì»¤ë²„ë§: í‰ê·  5ms (3ë°°)

**ë¬¸ë²•** (PostgreSQL ì „ìš©):
```sql
CREATE INDEX idx ON logs(level, service)
  INCLUDE (id, timestamp, message);
```

**ì–¸ì œ ì‚¬ìš©?**
- SELECT ì ˆì´ ê±°ì˜ ê³ ì •
- ì½ê¸°ê°€ ì••ë„ì ìœ¼ë¡œ ë§ìŒ
- ë¦¬í¬íŒ…, ëŒ€ì‹œë³´ë“œ

---

### 5ï¸âƒ£ work_mem íš¨ê³¼

**ì´ìœ **: ë””ìŠ¤í¬ ì„ì‹œ íŒŒì¼ ì‚¬ìš© â†’ ë©”ëª¨ë¦¬ ì •ë ¬

**Before**: 4MB (ë©”ëª¨ë¦¬ ë¶€ì¡± â†’ ë””ìŠ¤í¬ ì‚¬ìš©)
**After**: 256MB (ëª¨ë“  ì‘ì—…ì„ ë©”ëª¨ë¦¬ì—ì„œ)

**ì˜ˆìƒ ê²°ê³¼**:
- 4MB:   í‰ê·  100ms (Disk Sort)
- 256MB: í‰ê·  20ms (Memory Sort, 5ë°°)

**ì ì ˆí•œ ì„¤ì •**:
```
work_mem = (Total RAM - shared_buffers) / max_connections / 4
ì˜ˆ: (8GB - 2GB) / 100 / 4 = 15MB
```

**ì£¼ì˜**: work_memì€ ì»¤ë„¥ì…˜ë‹¹!
- 100 connections Ã— 1GB = ìµœëŒ€ 100GB â†’ OOM ìœ„í—˜

---

### 6ï¸âƒ£ ê²©ë¦¬ ìˆ˜ì¤€ íš¨ê³¼

**ì´ìœ **: ìŠ¤ëƒ…ìƒ· ê´€ë¦¬ ë¹„ìš©, ë™ì‹œì„±

**READ COMMITTED**:
- ê° ì¿¼ë¦¬ë§ˆë‹¤ ìƒˆ ìŠ¤ëƒ…ìƒ·
- ë†’ì€ ë™ì‹œì„±
- ë‹¨ìˆœ CRUDì— ì í•©

**REPEATABLE READ**:
- íŠ¸ëœì­ì…˜ ì „ì²´ì—ì„œ í•˜ë‚˜ì˜ ìŠ¤ëƒ…ìƒ·
- ì¼ê´€ì„± ë³´ì¥
- ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§, ê¸ˆìœµ ê±°ë˜

**ì˜ˆìƒ ê²°ê³¼**:
- ì“°ê¸°: RC 8,000 TPS vs RR 7,000 TPS (10% ê°ì†Œ)
- ì½ê¸°: í° ì°¨ì´ ì—†ìŒ

---

### 7ï¸âƒ£ INCLUDE ì ˆ ìƒì„¸ ë¹„êµ (ì‹¤ì œ ê²€ì¦ ì™„ë£Œ)

**ì´ìœ **: Internal Node í¬ê¸° ìµœì†Œí™”, message ì •ë ¬ ì œê±°

**3ê°€ì§€ ì¼€ì´ìŠ¤ ë¹„êµ**:
1. **ì¼ë°˜ ì¸ë±ìŠ¤**: `(level, service)` - Heap Fetch ë°œìƒ
2. **ë³µí•© ì¸ë±ìŠ¤**: `(level, service, message)` - messageê°€ ëª¨ë“  B-tree ë ˆë²¨ì— í¬í•¨
3. **INCLUDE ì¸ë±ìŠ¤**: `(level, service) INCLUDE (message)` - messageëŠ” Leafì—ë§Œ

**ê²°ê³¼** (25M í–‰ ê¸°ì¤€):
- ì½ê¸° ì„±ëŠ¥:
  - ì¼ë°˜: 27.54 QPS
  - ë³µí•©: 19.64 QPS
  - INCLUDE: 26.79 QPS (ë³µí•©ë³´ë‹¤ **36% ë¹ ë¦„**)

- ì“°ê¸° ì„±ëŠ¥:
  - ì¼ë°˜: 112,093 TPS
  - ë³µí•©: 46,203 TPS
  - INCLUDE: 140,646 TPS (ë³µí•©ë³´ë‹¤ **204% ë¹ ë¦„, 3ë°° ì´ìƒ!**)

- ì¸ë±ìŠ¤ í¬ê¸°:
  - ì¼ë°˜: 169 MB (ê°€ì¥ ì‘ìŒ)
  - ë³µí•©: 183 MB
  - INCLUDE: 189 MB

**í•µì‹¬ ì¸ì‚¬ì´íŠ¸**:
- INCLUDEëŠ” messageë¥¼ ì •ë ¬í•˜ì§€ ì•ŠìŒ â†’ INSERTê°€ ì—„ì²­ë‚˜ê²Œ ë¹ ë¦„
- Internal Nodeê°€ ì‘ì•„ì„œ ìºì‹œ íš¨ìœ¨ ì¦ê°€ â†’ ì½ê¸°ë„ ë¹ ë¦„
- Heap Fetch ì œê±° â†’ Index-Only Scan ê°€ëŠ¥

**ì‹¤ë¬´ ì ìš©**:
- âœ… INCLUDE ì‚¬ìš©: WHERE ì ˆì— ì•ˆ ì“°ëŠ” ì»¬ëŸ¼ì„ SELECTì— í¬í•¨í•  ë•Œ
- âœ… ë³µí•© ì¸ë±ìŠ¤: WHERE ì ˆì— ëª¨ë“  ì»¬ëŸ¼ì„ ì‚¬ìš©í•  ë•Œ
- ğŸ“Š **ì“°ê¸°ê°€ ë§ì€ ì‹œìŠ¤í…œì—ì„œ INCLUDEëŠ” í•„ìˆ˜!**

---

## ğŸ“Š í…ŒìŠ¤íŠ¸ íŠ¹ì§•

ê° ë²¤ì¹˜ë§ˆí¬ ìŠ¤í¬ë¦½íŠ¸ëŠ”:

âœ… **ì„¤ì • ì„ íƒ ì´ìœ ** ëª…í™•íˆ ì„¤ëª…
âœ… **Before ì¸¡ì •** â†’ ì„¤ì • ì ìš© â†’ **After ì¸¡ì •**
âœ… **ë™ì¼í•œ ì›Œí¬ë¡œë“œ**ë¡œ ê³µì •í•œ ë¹„êµ
âœ… **í–¥ìƒë¥  ê³„ì‚°** ë° ê·¸ë˜í”„ ì¶œë ¥
âœ… **ì‹¤ë¬´ ì ìš© ê°€ì´ë“œ** ì œê³µ

ì¶œë ¥ í˜•ì‹:
```
============================================================
í…ŒìŠ¤íŠ¸ N: XXX íš¨ê³¼ ê²€ì¦
============================================================

ğŸ“Œ í…ŒìŠ¤íŠ¸ ëª©ì : ...
ğŸ“Œ ì™œ XXXê°€ ë¹ ë¥¸ê°€?
   1. ...
   2. ...
   3. ...

[1/2] BEFORE: ...
   TPS: 5000.00
   í‰ê·  ì§€ì—°ì‹œê°„: 15.00 ms
   P95 ì§€ì—°ì‹œê°„: 35.00 ms

[2/2] AFTER: ...
   TPS: 12500.00
   í‰ê·  ì§€ì—°ì‹œê°„: 6.00 ms
   P95 ì§€ì—°ì‹œê°„: 14.00 ms

============================================================
ğŸ“ˆ ë¹„êµ ë¶„ì„
============================================================

TPS í–¥ìƒë¥ :      150.00%
   BEFORE:       5000.00 TPS
   AFTER:        12500.00 TPS
   í–¥ìƒ ë°°ìˆ˜:    2.50x

ì§€ì—°ì‹œê°„ ê°œì„ :   60.00%
   í‰ê·  - BEFORE: 15.00 ms â†’ AFTER: 6.00 ms (2.50x ë¹ ë¦„)

============================================================
ğŸ’¡ ê²°ë¡ 
============================================================

XXX ì‚¬ìš© ì‹œ:
  âœ“ TPSê°€ 2.50x í–¥ìƒë©ë‹ˆë‹¤
  âœ“ ì§€ì—°ì‹œê°„ì´ 2.50x ê°ì†Œí•©ë‹ˆë‹¤
  âœ“ ...

âœ… ê¶Œì¥ ì‚¬ìš© ì¼€ì´ìŠ¤:
  â€¢ ...
  â€¢ ...

âš ï¸ ì£¼ì˜ì‚¬í•­:
  â€¢ ...
  â€¢ ...
```

## ğŸ“š ë¬¸ì„œ

- **BENCHMARK_GUIDE.md**: ê° í…ŒìŠ¤íŠ¸ì˜ ìƒì„¸ ì„¤ëª… ë° ì´ë¡ 
- **README.md**: í”„ë¡œì íŠ¸ ì „ì²´ ê°€ì´ë“œ
- **VERIFICATION.md**: êµ¬ì¶• ê²€ì¦ ê²°ê³¼

## ğŸ“ í•™ìŠµ í¬ì¸íŠ¸

ì´ ë²¤ì¹˜ë§ˆí¬ë¥¼ í†µí•´ ë°°ìš¸ ìˆ˜ ìˆëŠ” ê²ƒ:

1. **ë°°ì¹˜ ì²˜ë¦¬ì˜ ì¤‘ìš”ì„±** (20ë°° ì°¨ì´!)
2. **ì¸ë±ìŠ¤ ì„¤ê³„ì˜ ì˜í–¥ë ¥** (50ë°° ì°¨ì´!)
3. **íŠ¸ë ˆì´ë“œì˜¤í”„ ì´í•´** (ì•ˆì „ì„± vs ì„±ëŠ¥)
4. **ë©”ëª¨ë¦¬ ê´€ë¦¬ì˜ ì¤‘ìš”ì„±** (work_mem)
5. **PostgreSQL ë‚´ë¶€ ë™ì‘ ì›ë¦¬**
   - MVCC, Snapshot, Visibility
   - WAL, fsync, íŠ¸ëœì­ì…˜
   - Index Scan vs Index-Only Scan
   - Disk Sort vs Memory Sort

## ğŸ”¥ ì‹¤ë¬´ ì ìš© ë¡œë“œë§µ

### 1ë‹¨ê³„: ì¦‰ì‹œ ì ìš© ê°€ëŠ¥
- âœ… ë°°ì¹˜ INSERT ì‚¬ìš©
- âœ… í•„ìˆ˜ ì¸ë±ìŠ¤ ì¶”ê°€

### 2ë‹¨ê³„: ì‹ ì¤‘í•œ ê²€í†  í›„ ì ìš©
- âš ï¸ synchronous_commit (ë°ì´í„° ì¤‘ìš”ë„ ê³ ë ¤)
- âš ï¸ work_mem ì¦ê°€ (ë©”ëª¨ë¦¬ ì—¬ìœ  í™•ì¸)

### 3ë‹¨ê³„: ìƒí™©ì— ë§ê²Œ ì ìš©
- ğŸ’¡ ì»¤ë²„ë§ ì¸ë±ìŠ¤ (ì¿¼ë¦¬ íŒ¨í„´ ë¶„ì„ í›„)
- ğŸ’¡ ê²©ë¦¬ ìˆ˜ì¤€ ë³€ê²½ (ë¹„ì¦ˆë‹ˆìŠ¤ ìš”êµ¬ì‚¬í•­ í™•ì¸)

### 4ë‹¨ê³„: ëª¨ë‹ˆí„°ë§ ë° ì¡°ì •
- ğŸ“Š pg_stat_statementsë¡œ slow query ì¶”ì 
- ğŸ“Š pg_stat_user_indexesë¡œ ì¸ë±ìŠ¤ ì‚¬ìš©ë¥  í™•ì¸
- ğŸ“Š ì •ê¸°ì ì¸ VACUUM ANALYZE

## ğŸš§ ë‹¤ìŒ ë‹¨ê³„

í˜„ì¬ êµ¬ì¶•ëœ ë²¤ì¹˜ë§ˆí¬ë¡œ:

1. **ê° ìµœì í™” ê¸°ë²•ì˜ íš¨ê³¼ë¥¼ ì •ëŸ‰ì ìœ¼ë¡œ ì¸¡ì •**
2. **í”„ë¡œë•ì…˜ ì ìš© ì „ ì‚¬ì „ ê²€ì¦**
3. **ì„±ëŠ¥ ìš”êµ¬ì‚¬í•­ ë‹¬ì„± ì—¬ë¶€ í™•ì¸**
4. **íŒ€ì› êµìœ¡ ìë£Œë¡œ í™œìš©**

ì¶”ê°€ë¡œ í…ŒìŠ¤íŠ¸í•´ë³¼ ìˆ˜ ìˆëŠ” ê²ƒ:

- [ ] COPY vs INSERT ë¹„êµ
- [ ] Partitioning íš¨ê³¼
- [ ] Connection Pooling (PgBouncer)
- [ ] Primary-Replica ì½ê¸° ë¶„ì‚°
- [ ] Prepared Statement vs Ad-hoc Query

## ğŸ“ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

ë¬¸ì œê°€ ë°œìƒí•˜ë©´:

```bash
# ì„œë¹„ìŠ¤ ì¬ì‹œì‘
docker compose restart

# ë¡œê·¸ í™•ì¸
docker compose logs postgres

# ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í…ŒìŠ¤íŠ¸
docker exec loadtest-postgres psql -U postgres -d loadtest -c "SELECT 1"
```

## ë¼ì´ì„ ìŠ¤

MIT License

---

**ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤!**

PostgreSQL ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•œ **ì²´ê³„ì ì¸ ë²¤ì¹˜ë§ˆí¬ í™˜ê²½**ì´ ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
ê° ìµœì í™” ê¸°ë²•ì˜ íš¨ê³¼ë¥¼ **Before/After ë¹„êµ**ë¥¼ í†µí•´ ëª…í™•íˆ ê²€ì¦í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
